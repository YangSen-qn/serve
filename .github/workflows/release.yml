name: Release

on:
  release:
    types:
      - published  # 当创建新的 Release 时触发（GitHub 会自动创建 tag）

jobs:
  build:
    name: Build Release
    runs-on: ubuntu-latest
    permissions:
      contents: read  # 需要读取权限来访问代码和 Release 信息
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Download dependencies
        shell: bash
        run: |
          go mod tidy
          go mod download
          go mod verify

      - name: Get version from release
        id: get_version
        shell: bash
        run: |
          # 从 Release 事件中获取 tag 名称（GitHub 创建 Release 时会自动创建 tag）
          VERSION="${{ github.event.release.tag_name }}"
          # 保留版本号中的 "v" 前缀（如果存在）
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Release: ${{ github.event.release.name }}"

      - name: Build
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          OUTPUT_NAME="serve"
          OUTPUT_DIR="serve_${{ steps.get_version.outputs.version }}_${{ matrix.goos }}_${{ matrix.goarch }}"
          if [ "${{ matrix.goos }}" = "windows" ]; then
            OUTPUT_NAME="serve.exe"
          fi
          mkdir -p "${OUTPUT_DIR}"
          go build -ldflags "-X main.version=${{ steps.get_version.outputs.version }}" \
            -o "${OUTPUT_DIR}/${OUTPUT_NAME}" \
            ./cmd/serve
          # 复制 README.md 到输出目录
          if [ -f "README.md" ]; then
            cp README.md "${OUTPUT_DIR}/"
          else
            echo "Warning: README.md not found"
          fi

      - name: Create archive
        shell: bash
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          OUTPUT_DIR="serve_${VERSION}_${{ matrix.goos }}_${{ matrix.goarch }}"
          if [ "${{ matrix.goos }}" = "windows" ]; then
            zip -r "serve_${VERSION}_${{ matrix.goos }}_${{ matrix.goarch }}.zip" \
              "${OUTPUT_DIR}"
          else
            tar -czf "serve_${VERSION}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz" \
              "${OUTPUT_DIR}"
          fi

      - name: Generate checksum
        shell: bash
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if [ "${{ matrix.goos }}" = "windows" ]; then
            sha256sum "serve_${VERSION}_${{ matrix.goos }}_${{ matrix.goarch }}.zip" >> checksums.txt
          else
            sha256sum "serve_${VERSION}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz" >> checksums.txt
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.goos }}-${{ matrix.goarch }}
          path: |
            serve_${{ steps.get_version.outputs.version }}_${{ matrix.goos }}_${{ matrix.goarch }}.*
            checksums.txt

  release:
    name: Upload Release Assets
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要写入权限来上传 Release 文件

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from release
        id: get_version
        shell: bash
        run: |
          # 从 Release 事件中获取 tag 名称
          VERSION="${{ github.event.release.tag_name }}"
          # 保留版本号中的 "v" 前缀（如果存在）
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$VERSION" >> $GITHUB_OUTPUT
          echo "Release: ${{ github.event.release.name }}"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        shell: bash
        run: |
          mkdir -p release
          # 合并所有平台的 artifacts
          find artifacts -name "*.tar.gz" -exec cp {} release/ \;
          find artifacts -name "*.zip" -exec cp {} release/ \;
          # 合并 checksums
          find artifacts -name "checksums.txt" -exec cat {} \; | sort -u > release/checksums.txt

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          tag_name: ${{ github.event.release.tag_name }}
          # Release 已经存在（由 GitHub Release 创建），只需要上传文件
          # 明确指定 tag_name 确保上传到正确的 Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

